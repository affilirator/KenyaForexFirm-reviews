---
import { SEO } from 'astro-seo';
import { site } from '@data/site';
import { ClientRouter } from 'astro:transitions';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';
import AuthorAttribution from '../components/common/AuthorAttribution.astro';
import { getDefaultAuthor } from '../lib/author-service';
import '@fontsource/playfair-display/400.css';
import '@fontsource/playfair-display/500.css';
import '@fontsource/playfair-display/600.css';
import '@fontsource/playfair-display/700.css';
import '@fontsource/source-sans-pro';
import type { Author } from '../types/author';
import '../styles/global.css';
import '../styles/toc.css';
import { organizationSchema } from '~/data/organizationSchema';
import { Font } from 'astro:assets';

export interface Props {
  title: string;
  description: string;
  type?: string;
  image?: string;
  noindex?: boolean;
  nofollow?: boolean;
  schemaData?: any;
  author?: Author;
  pubDate?: string;
  modDate?: string;
  keywords?: string;
}

const {
  title,
  description,
  pubDate = '2025-07-07',
  modDate = new Date().toISOString(),
  type = 'website',
  image = '/best-forex-brokers-kenyaforexfirm.png',
  noindex = false,
  author,
} = Astro.props;

let schemaData = Astro.props.schemaData;

const charset = 'UTF-8';

const homeTitle = `Expert Forex Broker Reviews, Analysis & Rankings in Kenya"`;
const homeDescription =
  'Comprehensive forex broker reviews and rankings for Kenyan traders. Expert analysis, regulatory information, and unbiased comparisons to help you choose the best forex broker.';
// Get default author if none is provided
let pageAuthor: Author | undefined = author;
if (!pageAuthor) {
  pageAuthor = await getDefaultAuthor();
}

const canonicalURL = `${site.url}${Astro.url.pathname}`;

const schemaTypes = ['CollectionPage', 'WebPage', 'Review', 'AboutPage'];

if (!schemaData) {
  schemaData = organizationSchema;
}

if (schemaData && !schemaData?.['@id']) {
  schemaData['@id'] =
    `${canonicalURL}#${Array.isArray(schemaData['@type']) ? schemaData['@type'][0]?.toLowerCase() : schemaData['@type']?.toLowerCase() || 'webpage'}`;

  if (
    !schemaData.publisher ||
    `${schemaData.publisher?.['@id']}` !== `${site.url}/#organization`
  ) {
    schemaData.publisher = {
      '@type': 'Organization',
      '@id': `${site.url}/#organization`,
    };
  }

  if (!schemaData.dateModified) {
    schemaData.dateModified = modDate;
  }

  if (
    !schemaData.author ||
    (pageAuthor &&
      `${schemaData.author?.['@id']}` !==
        `${site.url}/authors/${pageAuthor?.slug}`)
  ) {
    schemaData.author = {
      '@type': 'Person',
      name: pageAuthor?.name || 'Patrick Mahinge',
      url: pageAuthor ? `${site.url}/authors/${pageAuthor.slug}` : undefined,
      '@id': pageAuthor ? `${site.url}/authors/${pageAuthor.slug}` : undefined,
    };
  }
}
---

{
  /* 
<script is:inline>
	const getThemePreference = () => {
		if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
			return localStorage.getItem('theme');
		}
		return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
	};
	const isDark = getThemePreference() === 'dark';
	document.documentElement.classList[isDark ? 'add' : 'remove']('dark');
 
	if (typeof localStorage !== 'undefined') {
		const observer = new MutationObserver(() => {
			const isDark = document.documentElement.classList.contains('dark');
			localStorage.setItem('theme', isDark ? 'dark' : 'light');
		});
		observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
	}
</script>
*/
}

<html
  lang="en"
  dir="ltr"
  class="!scroll-smooth"
  transition:name="root"
  transition:animate="none"
  prefix="content: http://purl.org/rss/1.0/modules/content/  dc: http://purl.org/dc/terms/  foaf: http://xmlns.com/foaf/0.1/  og: http://ogp.me/ns#  rdfs: http://www.w3.org/2000/01/rdf-schema#  schema: http://schema.org/  sioc: http://rdfs.org/sioc/ns#  sioct: http://rdfs.org/sioc/types#  skos: http://www.w3.org/2004/02/skos/core#  xsd: http://www.w3.org/2001/XMLSchema# "
>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/svg+xml"
      href="/favicon.svg"
    />
    <meta
      name="generator"
      content={Astro.generator}
    />
    <link
      rel="stylesheet"
      href="https://fxmedia.kenyaforexfirm.com/fonts.css"
    />
    <link
      rel="privacy-policy"
      href="/privacy/"
    />
    <link
      rel="terms-of-service"
      href="/terms/"
    />
    <link
      rel="canonical"
      href={canonicalURL}
    />
    <link
      rel="stylesheet"
      href="/fonts/fonts.css"
    />
    <link
      rel="me"
      href="/authors/patrick-mahinge/"
    />
    <meta
      name="title"
      content={homeTitle}
    />
    <meta
      name="description"
      content={homeDescription}
    />
    <slot name="opengraph" />

    <SEO
      title={title}
      description={description}
      canonical={canonicalURL}
      openGraph={{
        basic: { title, type: type, image, url: canonicalURL },
        optional: { description, siteName: site.name },
        article:
          type === 'article'
            ? {
                authors: pageAuthor
                  ? [`${site.url}/authors/${pageAuthor.slug}`]
                  : undefined,
                publishedTime: pubDate ? pubDate : undefined,
                modifiedTime: modDate ? modDate : undefined,
                section: type === 'article' ? 'Finance' : undefined,
                //tags: pageAuthor?.tags || []
              }
            : undefined,
        image: {
          url: image,
          alt: title,
          width: 1024,
          height: 1024,
        },
      }}
      twitter={{
        creator: '@kenyaforexfirm',
        site: '@kenyaforexfirm',
        card: 'summary_large_image',
      }}
      extend={{
        meta: [{ name: 'theme-color', content: '#0ea5e9' }],
      }}
    />

    {
      /*  {schemaData && (
      <script is:inline type="application/ld+json" set:html={JSON.stringify(schemaData)} />
    )}
      */
    }

    {
      schemaData && !schemaData?.['@type'].includes('Article') && (
        <script
          is:inline
          type="application/ld+json"
          set:html={JSON.stringify(schemaData)}
        />
      )
    }
    {/** Organization schema is always included */}
    <script
      is:inline
      type="application/ld+json"
      set:html={JSON.stringify(organizationSchema)}
    />

    {/* Add author schema if not already included in schemaData */}
    {
      pageAuthor &&
        schemaData &&
        !schemaData?.mainEntity?.['@type']?.includes('Person') &&
        !(Array.isArray(schemaData)
          ? schemaData.some((item) => schemaTypes.includes(item['@type']))
          : schemaTypes.includes(schemaData?.['@type'])) && (
          <script
            type="application/ld+json"
            set:html={JSON.stringify({
              '@context': 'https://schema.org',
              '@type': 'Article',
              '@id': `${canonicalURL}#article`,
              headline: title,
              description: description,
              image: {
                '@type': 'ImageObject',
                url: `${site.url}${image}`,
                width: 1024,
                height: 1024,
              },
              datePublished: pubDate,
              dateModified: modDate,
              author: {
                '@type': 'Person',
                name: pageAuthor.name,
                url: `${site.url}/authors/${pageAuthor.slug}`,
                '@id': `${site.url}/authors/${pageAuthor.slug}`,
              },
              mainEntityOfPage: {
                '@type': 'WebPage',
                '@id': canonicalURL,
                primaryImageOfPage: {
                  '@type': 'ImageObject',
                  url: `${site.url}${image}`,
                  width: 1024,
                  height: 1024,
                },
                isPartOf: {
                  '@type': 'WebSite',
                  '@id': `${site.url}/#website`,
                  name: site.name,
                  url: site.url,
                  description: site.description,
                  publisher: {
                    '@type': 'Organization',
                    '@id': `${site.url}/#organization`,
                  },
                },
              },
              publisher: {
                '@type': 'Organization',
                name: site.name,
                '@id': `${site.url}/#organization`,
                url: site.url,
                logo: {
                  '@type': 'ImageObject',
                  url: `${site.url}/logo.png`,
                },
              },
            })}
          />
        )
    }
    <ClientRouter />
  </head>

  <body
    class="bg-background antialiased dark:bg-background flex flex-col overflow-x-hidden"
  >
    <div
      class="fixed inset-0 bg-cyber-grid opacity-20 pointer-events-none"
      style="background-size: 50px 50px;"
    >
    </div>
    <div
      class="fixed inset-0 bg-gradient-to-t from-neutral-950/50 via-transparent to-neutral-950/50 pointer-events-none"
    >
    </div>

    <main
      class="flex-grow w-full relative z-10 min-h-screen bg-gradient-to-br from-neutral-950 via-neutral-900 to-neutral-950 text-neutral-100"
    >
      <Navigation transition:animate="fade" />
      <slot />

      {
        pageAuthor && (
          <div class="!container mx-auto px-4 sm:px-6 lg:px-8 py-8 border-t border-neutral-800/50">
            <AuthorAttribution
              author={pageAuthor}
              transition:animate="slide"
            />
          </div>
        )
      }

      <Footer transition:animate="fade" />
    </main>

    <div class="fixed inset-0 pointer-events-none overflow-hidden">
      <div
        class="absolute top-20 left-10 w-32 h-32 bg-gradient-to-r from-primary-500/10 to-accent-500/10 rounded-full blur-xl"
      >
      </div>
      <div
        class="absolute top-40 right-20 w-24 h-24 bg-gradient-to-r from-accent-500/10 to-primary-500/10 rounded-full blur-xl"
      >
      </div>
    </div>
    <Font
      cssVariable="--font-roboto"
      preload
    />
    <Font
      cssVariable="--font-source-sans-3"
      preload
    />
    <Font
      cssVariable="--font-eb-garamond"
      preload
    />
    <Font
      cssVariable="--font-playfair-display"
      preload
    />

    <style>
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #171717;
      }
      ::-webkit-scrollbar-thumb {
        background: linear-gradient(to bottom, #0ea5e9, #d946ef);
        border-radius: 4px;
      }
    </style>
  </body>
</html>
