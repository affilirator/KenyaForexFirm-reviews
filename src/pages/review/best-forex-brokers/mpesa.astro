---
import BaseLayout from "~/layouts/BaseLayout.astro"
import { Image } from 'astro:assets';
import TopSlot from "~/components/slots/TopSlot.astro";
import BrokerList from "~/components/BrokerList.astro";
import BrokerDetails from "~/components/BrokerDetails.astro";
import SEOContent from "~/components/SEOContent.astro";
import { getReviews } from "~/lib/qs-esm";

const Response = await fetch('https://api.kenyaforexfirm.com/api/funding-methods/685630291c520ff162aba6b4?depth=3&draft=false&locale=en&trash=false')

const data = await Response.json()

const fallbackCdnUrl = 'https://fxmedia.kenyaforexfirm.com/kenyaforexfirm-api/r2media/OrangeIconLogo.webp'

const allBrokers = await getReviews();

const supportingBrokers = allBrokers.docs.filter(broker => 
  broker.brokerPaymentMethods?.some(method => 
    method.toLowerCase() === 'mpesa'.toLowerCase() //||
    //method.toLowerCase() === data?.name.toLowerCase()
  )
);
---
<BaseLayout title={data.title} description={data.title} >
    <TopSlot>
    
    <span slot="image">

      <Image src={data.image?.filename ? `https://fxmedia.kenyaforexfirm.com/kenyaforexfirm-api/r2media/${data.image.filename}` : (data.image?.url || fallbackCdnUrl)}
      alt={`${data?.title || data?.name} Logo`} 
      inferSize
      class=" mx-auto md:mx-0 rounded-full object-cover" />
      
    </span>

    <h1 slot="title" class="text-4xl md:text-5xl font-display font-bold text-white mb-6">
      Best Forex Brokers That Accept {data?.title || data?.name} in Kenya
    </h1>
    <p slot="subtitle" class="text-xl text-neutral-300 max-w-4xl mx-auto leading-relaxed">
      {data?.description || `Discover forex brokers that accept ${data?.title || data?.name} payments.`}
    </p>
  </TopSlot>
    <BrokerList 
    brokers={supportingBrokers}
    title={`${supportingBrokers.length} of Our Top-Rated Forex Brokers Accept ${data.title || data.name}`}
    description={`All brokers below accept ${data.title || data.name} for deposits and withdrawals.`}
  />

  <BrokerDetails brokers={supportingBrokers} filterType="payment" filterName={data.title || data.name} />

  <SEOContent type="payment" name={data.title || data.name} brokerCount={supportingBrokers.length} />
</BaseLayout>

