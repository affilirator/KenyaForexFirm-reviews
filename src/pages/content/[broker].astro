---

import { Image } from "astro:assets";

import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from '@/components/ui/breadcrumb';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Button, } from '@/components/ui/button';
import { Check, X, ShieldCheck, ArrowRight } from 'lucide-react';
import StarRating from '@/components/react/brokers/StarRating.astro';
import type { BrokerProps } from '@/types';
import ReviewSectionRenderer from '~/components/review-sections/ReviewSectionRenderer'
import AuthorBio from "~/components/article/AuthorBio.astro";
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
  } from "@/components/ui/table"
import RichText from '@/components/common/RichText';
import BaseLayout from "~/layouts/BaseLayout.astro";


export interface Broker {
  id: string;
  name: string;
  slug: string;
  logo: string;
//  logo: string | Media;
  summary: string;
  bestFor: string;
  minDeposit: number;
  regulation: string;
  maxLeverage: string;
  yearFounded: number;
  affiliateLink: string;
  reviewDate?: string | null;
  rating: {
    overall: number;
    fees: number;
    platforms: number;
    support: number;
    trust: number;
  };
  pros?:
    | {
        pro: string;
        id?: string | null;
      }[]
    | null;
  cons?:
    | {
        con: string;
        id?: string | null;
      }[]
    | null;
  fees?:
    | {
        accountType: string;
        avgSpread: string;
        commission: string;
        id?: string | null;
      }[]
    | null;
  verdict: string;
  fullReview: {
    root: {
      type: string;
      children: {
        type: string;
        version: number;
        [k: string]: unknown;
      }[];
      direction: ('ltr' | 'rtl') | null;
      format: 'left' | 'start' | 'center' | 'right' | 'end' | 'justify' | '';
      indent: number;
      version: number;
    };
    [k: string]: unknown;
  };
 // author: string | User;
  updatedAt: string;
  createdAt: string;
}

export async function getStaticPaths() {
    const res = await fetch('https://fx.mahinge.com/api/brokers');
  const { docs: brokers } = await res.json()
  return brokers.map((broker: Broker) => (
    {
    params: { broker: broker.slug },
    props: { broker } 
}));
}

const { broker } = Astro.props as { broker: Broker };
const brokerLogoUrl = broker.logo.url;
const jsonLd = {}; // Add your JSON-LD schema here
const newDate = new Date().toISOString();
const fullYear = new Date().getFullYear()

---
<BaseLayout title={broker.name} description={broker.summary} >

<div class="bg-background">
       
      <div class="container mx-auto px-4 md:px-6 py-6 md:py-12">
        <Breadcrumb className="mb-8">
          <BreadcrumbList>
            <BreadcrumbItem><BreadcrumbLink asChild><a href="/">Home</a></BreadcrumbLink></BreadcrumbItem>
            <BreadcrumbSeparator />
            <BreadcrumbItem><BreadcrumbLink asChild><a href="/best-forex-brokers">Brokers</a></BreadcrumbLink></BreadcrumbItem>
            <BreadcrumbSeparator />
            <BreadcrumbItem><BreadcrumbPage>{broker.name}</BreadcrumbPage></BreadcrumbItem>
          </BreadcrumbList>
        </Breadcrumb>
        
        <main class="grid lg:grid-cols-12 gap-6 lg:gap-12">
          <article class="lg:col-span-8">
            <header class="flex flex-col sm:flex-row items-start gap-4 sm:gap-6 mb-6 md:mb-8">
                <Image src={broker.logo.url} alt={`${broker.name} review Logo`} width={120} height={120} class="sm:w-[160px] sm:h-[160px] rounded-lg shadow-md border flex-shrink-0" />
                <div class="min-w-0 flex-1">
                    <h1 class="font-display text-2xl sm:text-3xl lg:text-4xl font-bold break-words">{broker.name} Review with Pros and Cons ({fullYear} Edition)</h1>
                    <p class="mt-2 text-base sm:text-lg text-muted-foreground">{broker.summary}</p>
                    <div class="mt-3 flex items-center gap-2">
                        <StarRating rating={broker.rating.overall} />
                        <span class="font-bold text-muted-foreground">({broker.rating.overall.toFixed(1)})</span>
                    </div>
                </div>
            </header>
            
            <div class="flex items-center gap-4 py-4 border-b border-neutral-700/50">
              <img src="/images/Patrick-Mahinge.webp" alt="Patrick Mahinge" class="h-12 w-12 rounded-full" />
              <div class="flex-1">
                <div class="flex flex-wrap items-center gap-4 text-sm text-neutral-300">
                  <span class="font-medium text-white">By Patrick Mahinge</span>
                  <span>{new Date(broker.createdAt || newDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                  <span>8 min read</span>
                </div>
              </div>
            </div>
            
            <Card className="bg-primary/5 border-primary/20 mt-6">
                <CardHeader>
                    <CardTitle className="font-display">The Verdict</CardTitle>
                </CardHeader>
                <CardContent>
                     <p class="mb-6">{broker.verdict}</p>
                     
                      <Button asChild size="lg" variant={'link'} className="bg-accent text-amber-50" >
                      <span class='inline-flex flex-row items-center gap-2 md:flex-row'>
                         <a href={broker.affiliateLink} target="_blank" rel="noopener noreferrer nofollow" class="inline-flex">
                            Visit {broker.name} 
                            <ArrowRight className="ml-2"/>
                        </a> </span>
                    </Button>
                    
                </CardContent>
            </Card>

            <section id="pros-cons" class="my-8 md:my-10">
                <div class="grid md:grid-cols-2 gap-6 md:gap-8">
                    <div>
                        <h3 class="font-display text-xl md:text-2xl font-bold flex items-center gap-2 mb-4"><Check className="h-6 w-6 md:h-8 md:w-8 text-green-500 flex-shrink-0"/> Pros</h3>
                        <ul class="space-y-2 list-inside">
                            {broker.pros?.map(pro => <li key={pro.id} class="flex items-start gap-2"><Check className="h-4 w-4 md:h-5 md:w-5 text-green-500 mt-1 shrink-0"/><span class="text-sm md:text-base break-words">{pro.pro}</span></li>)}
                        </ul>
                    </div>
                     <div>
                        <h3 class="font-display text-xl md:text-2xl font-bold flex items-center gap-2 mb-4"><X className="h-6 w-6 md:h-8 md:w-8 text-red-500 flex-shrink-0"/> Cons</h3>
                        <ul class="space-y-2 list-inside">
                            {broker.cons?.map(con => <li key={con.id} class="flex items-start gap-2"><X className="h-4 w-4 md:h-5 md:w-5 text-red-500 mt-1 shrink-0"/><span class="text-sm md:text-base break-words">{con.con}</span></li>)}
                        </ul>
                    </div>
                </div>
            </section>
            
            <section id="fees" class="my-8 md:my-10">
               <h2 class="font-display text-2xl md:text-3xl font-bold mb-4 break-words">{broker.name} Fees & Spreads</h2>
                 <p class="text-muted-foreground mb-6 text-sm md:text-base">Understanding the cost structure is crucial for profitable trading.</p>
                 <div class="overflow-x-auto">
                   <Table>
                      <TableHeader>
                          <TableRow>
                              <TableHead className="text-xs md:text-sm whitespace-nowrap">Account</TableHead>
                              <TableHead className="text-xs md:text-sm whitespace-nowrap">Avg. Spread (EUR/USD)</TableHead>
                              <TableHead className="text-xs md:text-sm whitespace-nowrap">Commission</TableHead>
                          </TableRow>
                      </TableHeader>
                      <TableBody>
                          {broker.fees?.map(fee => (
                              <TableRow key={fee.id}>
                                  <TableCell className="font-medium text-xs md:text-sm break-words">{fee.accountType}</TableCell>
                                  <TableCell className="text-xs md:text-sm">{fee.avgSpread}</TableCell>
                                  <TableCell className="text-xs md:text-sm break-words">{fee.commission}</TableCell>
                              </TableRow>
                          ))}
                      </TableBody>
                   </Table>
                 </div>
            </section>
            
            {/* Render Review Sections */}
            {broker.reviewSections && broker.reviewSections.length > 0 && (
              <div class="my-8 md:my-10">
                {broker.reviewSections.map((section: any, index: number) => {
                  // Map section types to broker ratings
                  const getRatingForSection = (blockType: string) => {
                    switch (blockType) {
                      case 'safety-regulation': return broker.rating?.trust;
                      case 'trading-conditions': return broker.rating?.fees;
                      case 'platforms-tools': return broker.rating?.platforms;
                      case 'customer-service': return broker.rating?.support;
                      default: return undefined;
                    }
                  };
                  
                  return (
                    <ReviewSectionRenderer
                      key={index}
                      blockType={section.blockType}
                      rating={getRatingForSection(section.blockType)}
                      {...section}
                    />
                  );
                })}
              </div>
            )}
            
            <RichText content={broker.fullReview} client:load />

            <AuthorBio 
              name="Patrick Mahinge"
              image="/images/Patrick-Mahinge.webp"
              bio="Patrick Mahinge is the founder of MahingeFX and a seasoned forex analyst with over 10 years of experience in financial markets. He specializes in broker analysis and trading education for African markets."
              profileUrl="/about/patrick-mahinge"
              socialas={{
                aedin: "https://aedin.com/in/patrick-mahinge",
                twitter: "https://twitter.com/patrickmahinge"
              }}
            />

            {/* TODO: Add Comments Section */}

          </article>
          <aside class="lg:col-span-4 space-y-6 lg:space-y-8">
              <div class="lg:sticky lg:top-24">
                <Card>
                    <CardHeader>
                        <CardTitle className="text-lg md:text-xl">Key Information</CardTitle>
                    </CardHeader>
                    <CardContent className="text-sm space-y-4">
                       <div class="flex justify-between items-start">
                           <span class="text-muted-foreground flex-shrink-0">Min. Deposit:</span>
                           <span class="font-semibold text-right">${broker.minDeposit}</span>
                       </div>
                        <div class="flex justify-between items-start">
                           <span class="text-muted-foreground flex-shrink-0">Regulation:</span>
                           <span class="font-semibold text-right break-words">{broker.regulation}</span>
                       </div>
                        <div class="flex justify-between items-start">
                           <span class="text-muted-foreground flex-shrink-0">Max. Leverage:</span>
                           <span class="font-semibold text-right">{broker.maxLeverage}</span>
                       </div>
                        <div class="flex justify-between items-start">
                           <span class="text-muted-foreground flex-shrink-0">Year Founded:</span>
                           <span class="font-semibold text-right">{broker.yearFounded}</span>
                       </div>
                    </CardContent>
                </Card>
                 <Card className="mt-6 lg:mt-8">
                    <CardHeader>
                        <CardTitle className="flex items-center gap-2 text-lg md:text-xl break-words"><ShieldCheck className="h-5 w-5 md:h-6 md:w-6 text-primary flex-shrink-0"/>Is {broker.name} Legit?</CardTitle>
                        <CardDescription className="text-sm">Our trust and safety analysis.</CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <div class="flex flex-col">
                            <span class="font-semibold text-sm md:text-base">Trust Score</span>
                             <div class="flex items-center gap-2">
                                <StarRating rating={broker.rating.trust} />
                                <span class="font-bold text-sm">({broker.rating.trust.toFixed(1)}/5.0)</span>
                            </div>
                        </div>
                        <p class="text-sm text-muted-foreground break-words">
                            {broker.name} is regulated by top-tier authorities like the {broker.regulation}, ensuring a high level of client fund protection and operational transparency.
                        </p>
                    </CardContent>
                </Card>
                <div class="mt-6 lg:mt-8">
                    <Button asChild className="w-full text-sm md:text-base" size="lg">
                         <a href={broker.affiliateLink} target="_blank" rel="noopener noreferrer nofollow" class="break-words text-center">
                            Open Account with {broker.name}
                        </a>
                    </Button>
                </div>
              </div>
          </aside>
        </main>
      </div>
    </div>
</BaseLayout>
  